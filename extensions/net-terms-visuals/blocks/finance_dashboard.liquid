{% comment %}
  ----------------------------------------------------------------------------------
  FINANCE PORTAL - PROFESSIONAL EDITION (Smart Filtering)
  - Added: "Show Only Unpaid" Toggle to clear clutter
  - Logic: Uses data attributes to hide/show rows instantly without reloading
  - Logic Preserved: Net Terms detection, Credit Calculation, and Security Checks
  ----------------------------------------------------------------------------------
{% endcomment %}

<div class="nt-portal-wrapper">
  
  <div class="nt-header">
    <div class="nt-header-content">
      <h1 class="nt-title">Finance Portal</h1>
      <p class="nt-subtitle">Manage your invoices and view payment status.</p>
    </div>
    
    <div class="nt-user-status">
      {% if customer %}
        <div class="nt-logged-in">
          <span class="nt-dot nt-dot-green"></span>
          <span>{{ customer.email }}</span>
        </div>
        
        {% if customer.tags contains 'Net30_Approved' %}
           <span class="nt-status-badge nt-badge-green">
             <span class="nt-checkmark">✓</span> Net Terms Active
           </span>
        {% elsif customer.tags contains 'Net30_Suspended' %}
           <span class="nt-status-badge nt-badge-red" style="background-color: #fee2e2; color: #991b1b;">
             ⛔ Account Suspended
           </span>
        {% else %}
           <span class="nt-status-badge nt-badge-amber">
             ⚠️ Standard Account
           </span>
        {% endif %}
      {% else %}
        <div class="nt-alert-login">
          <p>Please <a href="{{ routes.account_login_url }}">log in</a> to access the finance portal.</p>
        </div>
      {% endif %}
    </div>
  </div>

  {% if customer %}
  
    {% if customer.tags contains 'Net30_Approved' %}
      {% assign limit = customer.metafields.net_terms.credit_limit | default: 0 %}
      {% assign outstanding = customer.metafields.net_terms.outstanding | default: 0 %}
      {% assign available = limit | minus: outstanding %}

      <div class="nt-stats-grid">
        <div class="nt-card nt-card-main">
          <p class="nt-label">Available Credit</p>
          <p class="nt-stat nt-text-success">{{ available | money_without_currency | prepend: '$' }}</p>
          <div class="nt-progress-track">
             {% if limit > 0 %}
               {% assign percent_used = outstanding | times: 100.0 | divided_by: limit %}
               <div class="nt-progress-bar" style="width: {{ 100 | minus: percent_used }}%"></div>
             {% endif %}
          </div>
        </div>

        <div class="nt-card">
          <p class="nt-label">Outstanding Balance</p>
          <p class="nt-stat">{{ outstanding | money_without_currency | prepend: '$' }}</p>
        </div>

        <div class="nt-card nt-card-info">
           <div class="nt-row">
             <span class="nt-row-label">Total Limit</span>
             <span class="nt-row-val">{{ limit | money_without_currency | prepend: '$' }}</span>
           </div>
           <div class="nt-row mt-2">
             <span class="nt-row-label">Terms</span>
             <span class="nt-row-val">Net 30 Days</span>
           </div>
        </div>
      </div>
    {% elsif customer.tags contains 'Net30_Suspended' %}
      <div class="nt-notice-box" style="border-left: 4px solid #ef4444; background-color: #fef2f2;">
        <h4 style="margin: 0 0 5px 0; color: #b91c1c;">Make a Payment to Restore Access</h4>
        <p style="margin: 0;">Your Net Terms Net 30 privileges have been suspended due to overdue invoices. Please pay all overdue invoices to reinstate your credit line.</p>
      </div>
    {% else %}
      <div class="nt-notice-box">
        <p>Your account is not currently approved for Net Terms credit. Displaying standard order history below.</p>
      </div>
    {% endif %}

    <div class="nt-table-container">
      <div class="nt-table-header">
        <h3>Invoice History</h3>
        
        <div class="nt-filter-wrapper">
          <label class="nt-toggle-switch">
            <input type="checkbox" id="nt-hide-paid" checked onchange="togglePaidRows()">
            <span class="nt-slider"></span>
          </label>
          <span class="nt-filter-label">Hide Paid Orders</span>
        </div>
      </div>
      
      <div class="nt-overflow-scroll">
        <table class="nt-table" id="nt-invoice-table">
          <thead>
            <tr>
              <th class="nt-col-order">Order</th>
              <th class="nt-col-date">Date</th>
              <th class="nt-col-due">Due Date</th>
              <th class="nt-col-status">Status</th>
              <th class="nt-col-type">Type</th>
              <th class="nt-col-amount text-right">Amount</th>
              <th class="nt-col-action text-right">Action</th>
            </tr>
          </thead>
          <tbody>
            {% paginate customer.orders by 50 %}
              {% if customer.orders.size == 0 %}
                <tr>
                  <td colspan="6" class="nt-empty-state">
                    <p>No orders found on this account.</p>
                  </td>
                </tr>
              {% endif %}

              {% for order in customer.orders %}
                
                {% comment %} SECURITY CHECK: Explicitly ensure order belongs to logged-in user {% endcomment %}
                {% if order.customer.id != customer.id %}
                  {% continue %}
                {% endif %}

                {% comment %} 
                  --- LOGIC PRESERVED --- 
                  Identify if this is a "Net Terms" relevant order 
                {% endcomment %}
                {% assign is_net_terms = false %}
                {% for transaction in order.transactions %}
                  {% if transaction.gateway contains 'Net Terms' or transaction.gateway == 'manual' %}
                    {% assign is_net_terms = true %}
                  {% endif %}
                {% endfor %}
                {% if order.financial_status == 'pending' %}
                    {% assign is_net_terms = true %}
                {% endif %}

                {% comment %} SAFETY CHECK: If not Approved/Suspended, force Standard view {% endcomment %}
                {% unless customer.tags contains 'Net30_Approved' or customer.tags contains 'Net30_Suspended' %}
                  {% assign is_net_terms = false %}
                {% endunless %}

                {% comment %} Determine Filter Status {% endcomment %}
                {% assign row_status = 'paid' %}
                {% if order.financial_status == 'pending' or order.financial_status == 'partially_paid' %}
                   {% assign row_status = 'unpaid' %}
                {% endif %}

                {% comment %} CALCULATE DUE DATE (Net 30) {% endcomment %}
                {% assign created_seconds = order.created_at | date: "%s" | times: 1 %}
                {% assign net_30_seconds = 2592000 %}
                {% assign due_date_seconds = created_seconds | plus: net_30_seconds %}
                {% assign now_seconds = "now" | date: "%s" | times: 1 %}
                {% assign seconds_left = due_date_seconds | minus: now_seconds %}
                {% assign days_left = seconds_left | divided_by: 86400 %}
                
                {% assign urgency_class = "nt-text-safe" %}
                {% if seconds_left < 0 %}
                    {% assign urgency_class = "nt-text-overdue" %}
                {% elsif days_left <= 3 %}
                    {% assign urgency_class = "nt-text-urgent" %}
                {% elsif days_left <= 7 %}
                     {% assign urgency_class = "nt-text-warning" %}
                {% endif %}

                <tr class="nt-row-hover {% unless is_net_terms %}nt-row-dimmed{% endunless %}" data-status="{{ row_status }}">
                  <td class="font-medium">
                    <a href="{{ order.customer_url }}">{{ order.name }}</a>
                  </td>

                  <td class="text-subtle">
                    {{ order.created_at | date: "%b %d, %Y" }}
                  </td>

                  <td>
                    {% if row_status == 'unpaid' and is_net_terms %}
                        <div class="{{ urgency_class }}">
                           <span class="nt-text-small font-mono">{{ due_date_seconds | date: "%b %d" }}</span>
                           {% if seconds_left < 0 %}
                             <span class="nt-due-pill urgent">OVERDUE</span>
                           {% else %}
                             <span class="nt-due-pill {% if days_left <= 3 %}urgent{% endif %}">{{ days_left }}d left</span>
                           {% endif %}
                        </div>
                    {% else %}
                        <span class="text-subtle">-</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if order.financial_status == 'paid' %}
                      <span class="nt-badge nt-badge-green">Paid</span>
                    {% elsif order.financial_status == 'pending' or order.financial_status == 'partially_paid' %}
                      <span class="nt-badge nt-badge-amber">Unpaid</span>
                    {% else %}
                      <span class="nt-badge nt-badge-gray">{{ order.financial_status | capitalize }}</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if is_net_terms %}
                       <span class="nt-text-small nt-text-bold text-emerald">Net Terms</span>
                    {% else %}
                       <span class="nt-text-small text-subtle">Standard</span>
                    {% endif %}
                  </td>

                  <td class="text-right font-mono font-bold">
                    {{ order.total_price | money }}
                  </td>

                  <td class="text-right">
                    {% if order.financial_status == 'pending' or order.financial_status == 'partially_paid' %}
                       <button type="button" onclick="openPaymentModal('{{ order.name }}', '{{ order.total_price | money }}')" class="nt-btn nt-btn-primary">Pay Now</button>
                    {% else %}
                       <a href="{{ order.customer_url }}" class="nt-link-subtle">View</a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
              
              {% if paginate.pages > 1 %}
                <tr>
                  <td colspan="6" class="nt-pagination">
                    {{ paginate | default_pagination }}
                  </td>
                </tr>
              {% endif %}

            {% endpaginate %}
          </tbody>
        </table>
      </div>
    </div>

    <div id="nt-payment-modal" class="nt-modal-overlay" style="display: none;" onclick="if(event.target === this) closePaymentModal()">
      <div class="nt-modal-content">
        <span class="nt-modal-close" onclick="closePaymentModal()">&times;</span>
        <h3 class="nt-modal-title">Payment Instructions</h3>
        
        <p class="nt-modal-text">
          {% assign instructions = shop.metafields.net_terms.payment_instructions %}
          {% if instructions != blank %}
            {{ instructions | newline_to_br }}
          {% else %}
             Please contact us directly for payment arrangement details.
          {% endif %}
        </p>
        
        <div class="nt-modal-footer-info">
           <p><strong>Need Assistance?</strong></p>
           <p>If you have questions about your balance or need help with payment, please contact the <strong>{{ shop.name }}</strong> accounting team:</p>
           <p><a href="mailto:{{ shop.email }}">{{ shop.email }}</a></p>
        </div>

        <div class="nt-modal-actions">
           <button class="nt-btn nt-btn-primary" onclick="closePaymentModal()">Close</button>
        </div>
      </div>
    </div>
  
  {% endif %}
</div>

<script>
  function togglePaidRows() {
    const isChecked = document.getElementById('nt-hide-paid').checked;
    const rows = document.querySelectorAll('#nt-invoice-table tbody tr[data-status]');
    
    rows.forEach(row => {
      // If the row is PAID, we check the toggle.
      // If toggle is CHECKED, we HIDE paid rows.
      if (row.getAttribute('data-status') === 'paid') {
        row.style.display = isChecked ? 'none' : 'table-row';
      }
    });
  }
  
  function openPaymentModal(orderName, amount) {
    document.getElementById('nt-payment-modal').style.display = 'flex';
  }
  
  function closePaymentModal() {
    document.getElementById('nt-payment-modal').style.display = 'none';
  }

  // Run on load to apply initial state
  document.addEventListener("DOMContentLoaded", function() {
    togglePaidRows();
  });
</script>

{% style %}
  /* --- 1. LAYOUT & TYPOGRAPHY --- */
  .nt-portal-wrapper { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
  .nt-header { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 1.5rem; }
  @media(min-width: 768px) { .nt-header { flex-direction: row; justify-content: space-between; align-items: flex-end; } }
  
  .nt-title { font-size: 1.8rem; font-weight: 700; color: #0f172a; margin: 0; line-height: 1.2; }
  .nt-subtitle { color: #64748b; margin-top: 0.25rem; font-size: 1.1rem; }
  .nt-label { font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; margin-bottom: 0.25rem; }
  
  /* --- 2. HEADER & FILTER CONTROLS --- */
  .nt-table-header { padding: 1rem 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
  .nt-table-header h3 { margin: 0; font-size: 1.2rem; font-weight: 700; color: #1e293b; }
  
  .nt-filter-wrapper { display: flex; align-items: center; gap: 0.75rem; }
  .nt-filter-label { font-size: 1rem; color: #475569; font-weight: 500; }
  
  /* Toggle Switch Styles */
  .nt-toggle-switch { position: relative; display: inline-block; width: 40px; height: 22px; }
  .nt-toggle-switch input { opacity: 0; width: 0; height: 0; }
  .nt-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
  .nt-slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
  input:checked + .nt-slider { background-color: #0f172a; }
  input:checked + .nt-slider:before { transform: translateX(18px); }

  /* --- 3. USER STATUS --- */
  .nt-user-status { text-align: left; }
  @media(min-width: 768px) { .nt-user-status { text-align: right; } }
  .nt-logged-in { display: flex; align-items: center; gap: 0.5rem; font-size: 1rem; color: #475569; margin-bottom: 0.5rem; justify-content: flex-start; }
  @media(min-width: 768px) { .nt-logged-in { justify-content: flex-end; } }
  
  .nt-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .nt-dot-green { background-color: #10b981; }
  .nt-status-badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
  .nt-badge-green { background-color: #d1fae5; color: #065f46; }
  .nt-badge-amber { background-color: #fef3c7; color: #92400e; }
  .nt-badge-gray { background-color: #f1f5f9; color: #475569; }
  .nt-checkmark { margin-right: 4px; font-size: 1.1em; }

  /* --- 4. CARDS --- */
  .nt-stats-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem; }
  @media(min-width: 768px) { .nt-stats-grid { grid-template-columns: repeat(3, 1fr); } }
  
  .nt-card { background: #fff; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); position: relative; overflow: hidden; }
  .nt-card-info { background: #f8fafc; display: flex; flex-direction: column; justify-content: center; }
  
  .nt-stat { font-size: 2.25rem; font-weight: 700; color: #0f172a; margin: 0; font-family: monospace; }
  .nt-text-success { color: #059669; }
  .nt-text-small { font-size: 0.85rem; }
  .nt-text-bold { font-weight: 700; }
  .text-emerald { color: #059669; }
  
  /* Urgency Colors */
  .nt-text-safe { color: #059669; } /* Green */
  .nt-text-warning { color: #d97706; } /* Amber */
  .nt-text-urgent { color: #dc2626; font-weight: 700; } /* Red */
  .nt-text-overdue { color: #b91c1c; font-weight: 800; } /* Dark Red */
  
  .nt-due-pill { display: inline-block; font-size: 0.85rem; padding: 2px 6px; border-radius: 4px; background: #f1f5f9; margin-left: 6px; border: 1px solid #e2e8f0; }
  .nt-due-pill.urgent { background: #fef2f2; border-color: #fecaca; color: #b91c1c; }
  
  .nt-row { display: flex; justify-content: space-between; align-items: center; }
  .nt-row-label { font-size: 1rem; color: #64748b; font-weight: 500; }
  .nt-row-val { font-size: 1.2rem; color: #0f172a; font-weight: 600; font-family: monospace; }

  /* --- 5. PROGRESS BAR --- */
  .nt-progress-track { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: #f1f5f9; }
  .nt-progress-bar { height: 100%; background: #10b981; }

  /* --- 6. TABLE --- */
  .nt-table-container { background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
  
  .nt-overflow-scroll { overflow-x: auto; }
  .nt-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 1rem; }
  .nt-table th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.85rem; padding: 0.75rem 1.5rem; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0; }
  .nt-table td { padding: 1rem 1.5rem; color: #334155; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
  
  .nt-row-hover:hover td { background-color: #f8fafc; }
  .nt-row-dimmed td { opacity: 0.6; }
  .nt-row-dimmed:hover td { opacity: 1; } /* Restore opacity on hover */
  
  .text-right { text-align: right; }
  .text-subtle { color: #94a3b8; font-size: 0.9rem; }
  .font-mono { font-family: monospace; }
  .font-medium { font-weight: 500; }

  /* --- 7. BUTTONS & LINKS --- */
  .nt-btn { display: inline-block; padding: 0.35rem 0.85rem; font-size: 0.9rem; font-weight: 600; border-radius: 4px; text-decoration: none; transition: background-color 0.2s; white-space: nowrap; }
  .nt-btn-primary { background-color: #0f172a; color: #ffffff; }
  .nt-btn-primary:hover { background-color: #334155; color: #ffffff; }
  
  .nt-link-subtle { color: #64748b; font-size: 0.9rem; font-weight: 500; text-decoration: none; }
  .nt-link-subtle:hover { color: #0f172a; text-decoration: underline; }

  .nt-notice-box { padding: 1rem; background-color: #fffbeb; border: 1px solid #fcd34d; border-radius: 0.375rem; margin-bottom: 1.5rem; font-size: 1rem; color: #92400e; }
  .nt-alert-login { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1rem; color: #b45309; }
  .nt-pagination { text-align: center; padding: 1rem; color: #64748b; }

  /* --- 8. MODAL --- */
  .nt-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; justify-content: center; align-items: center; }
  .nt-modal-content { background: #fff; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; }
  .nt-modal-close { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; color: #64748b; line-height: 1; }
  .nt-modal-close:hover { color: #0f172a; }
  .nt-modal-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem; color: #0f172a; }
  .nt-modal-text { font-size: 1rem; color: #475569; margin-bottom: 1.5rem; line-height: 1.5; }
  .nt-modal-actions { text-align: right; margin-top: 1.5rem; }
  
  .nt-modal-footer-info { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0; font-size: 0.9rem; color: #64748b; }
  .nt-modal-footer-info p { margin: 0.25rem 0; }
  .nt-modal-footer-info a { color: #0f172a; text-decoration: underline; }
{% endstyle %}

{% schema %}
{
  "name": "Finance Dashboard",
  "target": "section",
  "settings": []
}
{% endschema %}