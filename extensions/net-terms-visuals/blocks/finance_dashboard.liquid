{% comment %}
  ----------------------------------------------------------------------------------
  FINANCE PORTAL - PROFESSIONAL EDITION (Shopify Compliant)
  - Replaces Tailwind with Scoped CSS (No external scripts)
  - Preserves exact logic for "Net Terms" detection from previous debug version
  - Handles "Approved" vs "Standard" views securely
  ----------------------------------------------------------------------------------
{% endcomment %}

<div class="nt-portal-wrapper">
  
  <div class="nt-header">
    <div class="nt-header-content">
      <h1 class="nt-title">Finance Portal</h1>
      <p class="nt-subtitle">Manage your invoices and view payment status.</p>
    </div>
    
    <div class="nt-user-status">
      {% if customer %}
        <div class="nt-logged-in">
          <span class="nt-dot nt-dot-green"></span>
          <span>{{ customer.email }}</span>
        </div>
        
        {% if customer.tags contains 'Net30_Approved' %}
           <span class="nt-status-badge nt-badge-green">
             <span class="nt-checkmark">✓</span> Net Terms Active
           </span>
        {% else %}
           <span class="nt-status-badge nt-badge-amber">
             ⚠️ Standard Account
           </span>
        {% endif %}
      {% else %}
        <div class="nt-alert-login">
          <p>Please <a href="{{ routes.account_login_url }}">log in</a> to access the finance portal.</p>
        </div>
      {% endif %}
    </div>
  </div>

  {% if customer %}
  
    {% if customer.tags contains 'Net30_Approved' %}
      {% assign limit = customer.metafields.net_terms.credit_limit | default: 0 %}
      {% assign outstanding = customer.metafields.net_terms.outstanding | default: 0 %}
      {% assign available = limit | minus: outstanding %}

      <div class="nt-stats-grid">
        <div class="nt-card nt-card-main">
          <p class="nt-label">Available Credit</p>
          <p class="nt-stat nt-text-success">{{ available | money_without_currency | prepend: '$' }}</p> <div class="nt-progress-track">
             {% if limit > 0 %}
               {% assign percent_used = outstanding | times: 100.0 | divided_by: limit %}
               <div class="nt-progress-bar" style="width: {{ 100 | minus: percent_used }}%"></div>
             {% endif %}
          </div>
        </div>

        <div class="nt-card">
          <p class="nt-label">Outstanding Balance</p>
          <p class="nt-stat">{{ outstanding | money_without_currency | prepend: '$' }}</p>
        </div>

        <div class="nt-card nt-card-info">
           <div class="nt-row">
             <span class="nt-row-label">Total Limit</span>
             <span class="nt-row-val">{{ limit | money_without_currency | prepend: '$' }}</span>
           </div>
           <div class="nt-row mt-2">
             <span class="nt-row-label">Terms</span>
             <span class="nt-row-val">Net 30 Days</span>
           </div>
        </div>
      </div>
    {% else %}
      <div class="nt-notice-box">
        <p>Your account is not currently approved for Net Terms credit. Displaying standard order history below.</p>
      </div>
    {% endif %}

    <div class="nt-table-container">
      <div class="nt-table-header">
        <h3>Recent Transactions</h3>
      </div>
      
      <div class="nt-overflow-scroll">
        <table class="nt-table">
          <thead>
            <tr>
              <th class="nt-col-order">Order</th>
              <th class="nt-col-date">Date</th>
              <th class="nt-col-status">Status</th>
              <th class="nt-col-type">Type</th> <th class="nt-col-amount text-right">Amount</th>
              <th class="nt-col-action text-right">Action</th>
            </tr>
          </thead>
          <tbody>
            {% paginate customer.orders by 20 %}
              {% if customer.orders.size == 0 %}
                <tr>
                  <td colspan="6" class="nt-empty-state">
                    <p>No orders found on this account.</p>
                  </td>
                </tr>
              {% endif %}

              {% for order in customer.orders %}
                
                {% comment %} 
                  --- LOGIC PRESERVED FROM DEBUG CODE --- 
                  Identify if this is a "Net Terms" relevant order 
                {% endcomment %}
                {% assign is_net_terms = false %}
                {% for transaction in order.transactions %}
                  {% if transaction.gateway contains 'Net Terms' or transaction.gateway == 'manual' %}
                    {% assign is_net_terms = true %}
                  {% endif %}
                {% endfor %}
                {% if order.financial_status == 'pending' %}
                    {% assign is_net_terms = true %}
                {% endif %}

                <tr class="nt-row-hover {% unless is_net_terms %}nt-row-dimmed{% endunless %}">
                  <td class="font-medium">
                    <a href="{{ order.customer_url }}">{{ order.name }}</a>
                  </td>

                  <td class="text-subtle">
                    {{ order.created_at | date: "%b %d, %Y" }}
                  </td>

                  <td>
                    {% if order.financial_status == 'paid' %}
                      <span class="nt-badge nt-badge-green">Paid</span>
                    {% elsif order.financial_status == 'pending' or order.financial_status == 'partially_paid' %}
                      <span class="nt-badge nt-badge-amber">Unpaid</span>
                    {% else %}
                      <span class="nt-badge nt-badge-gray">{{ order.financial_status | capitalize }}</span>
                    {% endif %}
                  </td>

                  <td>
                    {% if is_net_terms %}
                       <span class="nt-text-small nt-text-bold text-emerald">Net Terms</span>
                    {% else %}
                       <span class="nt-text-small text-subtle">Standard</span>
                    {% endif %}
                  </td>

                  <td class="text-right font-mono font-bold">
                    {{ order.total_price | money }}
                  </td>

                  <td class="text-right">
                    {% if order.financial_status == 'pending' or order.financial_status == 'partially_paid' %}
                       <a href="{{ order.order_status_url }}" class="nt-btn nt-btn-primary">Pay Now</a>
                    {% else %}
                       <a href="{{ order.customer_url }}" class="nt-link-subtle">View</a>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
              
              {% if paginate.pages > 1 %}
                <tr>
                  <td colspan="6" class="nt-pagination">
                    {{ paginate | default_pagination }}
                  </td>
                </tr>
              {% endif %}

            {% endpaginate %}
          </tbody>
        </table>
      </div>
    </div>
  
  {% endif %}
</div>

{% style %}
  /* --- 1. LAYOUT & TYPOGRAPHY --- */
  .nt-portal-wrapper { max-width: 1200px; margin: 0 auto; padding: 2rem 1rem; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
  .nt-header { display: flex; flex-direction: column; gap: 1rem; margin-bottom: 2rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 1.5rem; }
  @media(min-width: 768px) { .nt-header { flex-direction: row; justify-content: space-between; align-items: flex-end; } }
  
  .nt-title { font-size: 1.5rem; font-weight: 700; color: #0f172a; margin: 0; line-height: 1.2; }
  .nt-subtitle { color: #64748b; margin-top: 0.25rem; font-size: 0.95rem; }
  .nt-label { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; margin-bottom: 0.25rem; }
  
  /* --- 2. USER STATUS --- */
  .nt-user-status { text-align: left; }
  @media(min-width: 768px) { .nt-user-status { text-align: right; } }
  .nt-logged-in { display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #475569; margin-bottom: 0.5rem; justify-content: flex-start; }
  @media(min-width: 768px) { .nt-logged-in { justify-content: flex-end; } }
  
  .nt-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
  .nt-dot-green { background-color: #10b981; }
  .nt-status-badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
  .nt-badge-green { background-color: #d1fae5; color: #065f46; }
  .nt-badge-amber { background-color: #fef3c7; color: #92400e; }
  .nt-badge-gray { background-color: #f1f5f9; color: #475569; }
  .nt-checkmark { margin-right: 4px; font-size: 1.1em; }

  /* --- 3. CARDS --- */
  .nt-stats-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; margin-bottom: 2rem; }
  @media(min-width: 768px) { .nt-stats-grid { grid-template-columns: repeat(3, 1fr); } }
  
  .nt-card { background: #fff; padding: 1.5rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); position: relative; overflow: hidden; }
  .nt-card-info { background: #f8fafc; display: flex; flex-direction: column; justify-content: center; }
  
  .nt-stat { font-size: 1.75rem; font-weight: 700; color: #0f172a; margin: 0; font-family: monospace; }
  .nt-text-success { color: #059669; }
  .nt-text-small { font-size: 0.75rem; }
  .nt-text-bold { font-weight: 700; }
  .text-emerald { color: #059669; }
  
  .nt-row { display: flex; justify-content: space-between; align-items: center; }
  .nt-row-label { font-size: 0.875rem; color: #64748b; font-weight: 500; }
  .nt-row-val { font-size: 1rem; color: #0f172a; font-weight: 600; font-family: monospace; }

  /* --- 4. PROGRESS BAR --- */
  .nt-progress-track { position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; background: #f1f5f9; }
  .nt-progress-bar { height: 100%; background: #10b981; }

  /* --- 5. TABLE --- */
  .nt-table-container { background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
  .nt-table-header { padding: 1rem 1.5rem; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
  .nt-table-header h3 { margin: 0; font-size: 1rem; font-weight: 700; color: #1e293b; }
  
  .nt-overflow-scroll { overflow-x: auto; }
  .nt-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 0.875rem; }
  .nt-table th { background: #f8fafc; color: #64748b; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; padding: 0.75rem 1.5rem; letter-spacing: 0.05em; border-bottom: 1px solid #e2e8f0; }
  .nt-table td { padding: 1rem 1.5rem; color: #334155; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
  
  .nt-row-hover:hover td { background-color: #f8fafc; }
  .nt-row-dimmed td { opacity: 0.6; }
  .nt-row-dimmed:hover td { opacity: 1; } /* Restore opacity on hover */
  
  .text-right { text-align: right; }
  .text-subtle { color: #94a3b8; font-size: 0.8rem; }
  .font-mono { font-family: monospace; }
  .font-medium { font-weight: 500; }

  /* --- 6. BUTTONS & LINKS --- */
  .nt-btn { display: inline-block; padding: 0.35rem 0.85rem; font-size: 0.75rem; font-weight: 600; border-radius: 4px; text-decoration: none; transition: background-color 0.2s; white-space: nowrap; }
  .nt-btn-primary { background-color: #0f172a; color: #ffffff; }
  .nt-btn-primary:hover { background-color: #334155; color: #ffffff; }
  
  .nt-link-subtle { color: #64748b; font-size: 0.75rem; font-weight: 500; text-decoration: none; }
  .nt-link-subtle:hover { color: #0f172a; text-decoration: underline; }

  .nt-notice-box { padding: 1rem; background-color: #fffbeb; border: 1px solid #fcd34d; border-radius: 0.375rem; margin-bottom: 1.5rem; font-size: 0.875rem; color: #92400e; }
  .nt-alert-login { background: #fffbeb; border-left: 4px solid #f59e0b; padding: 1rem; color: #b45309; }
  .nt-pagination { text-align: center; padding: 1rem; color: #64748b; }
{% endstyle %}

{% schema %}
{
  "name": "Finance Dashboard",
  "target": "section",
  "settings": []
}
{% endschema %}